---
- name: Install and configure SAMBA shares on the server
  hosts: "{{ server }}"
  vars_files:
    - vars/config.yml
  tasks:
    - name: Add system user 
      ansible.builtin.user:
        name: "{{ user }}"
        shell: /bin/bash
        append: yes
    - name: SMB install and config
      ansible.builtin.import_role:
        name: vladgh.samba.server
      vars:
        samba_users:
        - name: "{{ user }}"
          password: "{{ smb_password }}"
        samba_shares:
        - name: "{{ share_name }}"
          group: "{{ user }}" 
          write_list: "{{ user }}"
        samba_shares_root: /data
    - name: fw zone
      ansible.posix.firewalld:
        zone: custom
        permanent: true
        state: present
    - name: Add services to new zone
      firewalld:
        service: "{{ item }}"
        state: enabled
        permanent: true
        immediate: yes
      loop:
        - samba
        - ssh
    - name: Add port to new zone
      firewalld:
        port: 4312/tcp
        state: enabled
        permanent: true
        immediate: yes

- name: mount SAMBA share on the client
  hosts: "{{ client }}"
  vars_files:
    - vars/config.yml
  tasks:
    - name: Create a directory if it does not exist
      ansible.builtin.file:
        path: "{{ mount_path }}"
        state: directory
        mode: '0777'
    - name: Install cifs-utils
      ansible.builtin.dnf:
        name: cifs-utils
        state: present
      notify: make fstab entry
  handlers:
    - name: make fstab entry
      ansible.posix.mount:
        src: "{{ '//' + server + '/' + share_name }}"
        path: "{{ mount_path }}"
        opts: "{{ 'user=' + user + ',password=' + smb_password }}"  
        state: mounted
        fstype: cifs

